{% extends "bases/private.html" %}

{% block title %}Personal Settings - Creative Portfolio{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h1 class="mb-4">Personal Settings</h1>
            
            <!-- Profile Settings Form -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Profile Information</h5>
                    
                    <form id="settingsForm">
                        <!-- Full Name -->
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" name="full_name" 
                                   value="{{ user.full_name }}" required>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ user.email }}" required>
                        </div>

                        <!-- Bio -->
                        <div class="mb-3">
                            <label for="bio" class="form-label">Bio</label>
                            <textarea class="form-control" id="bio" name="bio" rows="4" 
                                      maxlength="500">{{ user.bio if user.bio else '' }}</textarea>
                            <div class="form-text">
                                <span id="bioCount">{{ user.bio|length if user.bio else 0 }}</span>/500 characters
                            </div>
                        </div>

                        <!-- Profile Picture -->
                        <div class="mb-3">
                            <label for="profilePicture" class="form-label">Profile Picture</label>
                            {% if user.profile_picture_data %}
                            <div class="mb-2">
                                <img src="data:{{ user.profile_picture_mime_type }};base64,{{ user.profile_picture_data }}" 
                                     alt="Profile Picture" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                            {% endif %}
                            <input type="file" class="form-control" id="profilePicture" name="profile_picture" 
                                   accept="image/jpeg,image/png,image/gif">
                            <div class="form-text">Max size: 5MB. Formats: JPEG, PNG, GIF</div>
                        </div>

                        <!-- Current Password (required for email/password changes) -->
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" name="current_password">
                            <div class="form-text">Required to change email or password</div>
                        </div>

                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password (optional)</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password">
                            <div class="form-text">Min 8 characters, must include uppercase, lowercase, and number</div>
                        </div>

                        <!-- Hidden field for concurrent edit detection -->
                        <input type="hidden" id="updatedAt" value="{{ user.updated_at }}">
                        
                        <!-- CSRF Token -->
                        <input type="hidden" id="csrfToken" value="{{ csrf_token() }}">

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="messageArea" class="mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Bio character counter
    const bioTextarea = document.getElementById('bio');
    const bioCount = document.getElementById('bioCount');
    
    bioTextarea.addEventListener('input', function() {
        bioCount.textContent = this.value.length;
    });

    // Form submission handler
    const settingsForm = document.getElementById('settingsForm');
    const messageArea = document.getElementById('messageArea');

    settingsForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {
            csrf_token: document.getElementById('csrfToken').value,
            full_name: formData.get('full_name'),
            email: formData.get('email'),
            bio: formData.get('bio'),
            current_password: formData.get('current_password'),
            new_password: formData.get('new_password'),
            updated_at: document.getElementById('updatedAt').value
        };

        // Handle profile picture if selected
        const pictureFile = formData.get('profile_picture');
        if (pictureFile && pictureFile.size > 0) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                // Extract base64 data (remove data:image/xxx;base64, prefix)
                const base64Data = e.target.result.split(',')[1];
                data.profile_picture_data = base64Data;
                await submitForm(data);
            };
            reader.readAsDataURL(pictureFile);
        } else {
            await submitForm(data);
        }
    });

    async function submitForm(data) {
        try {
            const response = await fetch('/settings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                showMessage('success', result.message || 'Settings updated successfully!');
                // Update hidden timestamp for next save
                if (result.user && result.user.updated_at) {
                    document.getElementById('updatedAt').value = result.user.updated_at;
                }
                // Reload page after short delay to show updated data
                setTimeout(() => window.location.reload(), 1500);
            } else {
                if (response.status === 409) {
                    showMessage('warning', 'Your settings were modified in another window. Please refresh and try again.');
                } else if (response.status === 400) {
                    const errors = result.errors || {};
                    const errorMsg = Object.values(errors).join(', ') || result.error;
                    showMessage('danger', 'Validation error: ' + errorMsg);
                } else {
                    showMessage('danger', result.error || 'Failed to update settings');
                }
            }
        } catch (error) {
            console.error('Error updating settings:', error);
            showMessage('danger', 'An error occurred. Please try again.');
        }
    }

    function showMessage(type, message) {
        messageArea.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    // Cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Discard unsaved changes?')) {
            window.location.reload();
        }
    });
</script>
{% endblock %}
