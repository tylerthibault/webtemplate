{% extends "bases/private.html" %}

{% block title %}User Management - Superuser{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/components/tabs.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">User Management</h1>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-info">Total Users: {{ users|length }}</span>
                    <button type="button" class="btn btn-success" onclick="openAddUserModal()" id="addUserToRoleBtn">
                        <i class="bi bi-plus-circle"></i> <span id="addButtonText">Add User to Role</span>
                    </button>
                </div>
            </div>

            <!-- Role Filter Tabs -->
            <div class="card mb-3" data-tab-container="user-management">
                <div class="card-header">
                    <ul class="nav nav-pills" id="roleFilterTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#all-users" 
                                    data-tab-id="all" type="button" role="tab">
                                All Users <span class="badge bg-light text-dark ms-1" id="all-count">{{ users|length }}</span>
                            </button>
                        </li>
                        {% for role in roles %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#{{ role.name }}-users" 
                                    data-tab-id="{{ role.name }}" type="button" role="tab">
                                {{ role.name|title }} <span class="badge bg-light text-dark ms-1" id="{{ role.name }}-count">0</span>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            {% if users %}
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="usersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Full Name</th>
                                    <th>Roles</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr class="user-row {% if not user.is_active %}table-secondary{% endif %}" 
                                    data-user-roles="{{ user.roles|join(',') }}" data-user-id="{{ user._id }}">
                                    <td>{{ user._id }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.full_name }}</td>
                                    <td>
                                        {% if user.roles %}
                                            {% for role in user.roles %}
                                                <span class="badge bg-primary me-1">{{ role }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No roles</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                        {% if user.get('force_password_change', False) %}
                                            <span class="badge bg-warning text-dark">Password Reset Required</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <!-- Role Management Dropdown -->
                                            <div class="dropdown me-1">
                                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    Roles
                                                </button>
                                                <ul class="dropdown-menu">
                                                    {% for role in roles %}
                                                    <li>
                                                        {% if role.name in user.roles %}
                                                        <button type="button" class="dropdown-item text-danger" 
                                                                onclick="confirmAction('Remove {{ role.name }} role from {{ user.email }}?', '/superuser/users/{{ user._id }}/change-role', {role_name: '{{ role.name }}', action: 'remove'})">
                                                            Remove {{ role.name }}
                                                        </button>
                                                        {% else %}
                                                        <button type="button" class="dropdown-item text-success"
                                                                onclick="confirmAction('Add {{ role.name }} role to {{ user.email }}?', '/superuser/users/{{ user._id }}/change-role', {role_name: '{{ role.name }}', action: 'add'})">
                                                            Add {{ role.name }}
                                                        </button>
                                                        {% endif %}
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>

                                            <!-- User Status Actions -->
                                            {% if user.is_active %}
                                            <button type="button" class="btn btn-sm btn-outline-warning me-1"
                                                    onclick="confirmAction('Deactivate user {{ user.email }}?', '/superuser/users/{{ user._id }}/soft-delete')">
                                                Deactivate
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-success me-1"
                                                    onclick="confirmAction('Reactivate user {{ user.email }}?', '/superuser/users/{{ user._id }}/reactivate')">
                                                Reactivate
                                            </button>
                                            {% endif %}

                                            <!-- Force Password Change -->
                                            <button type="button" class="btn btn-sm btn-outline-info me-1"
                                                    onclick="confirmAction('Force password change for {{ user.email }}?', '/superuser/users/{{ user._id }}/force-password-change')">
                                                Reset Password
                                            </button>

                                            <!-- Danger Zone Dropdown -->
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    Danger
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <form method="POST" action="{{ url_for('superuser.delete_user', user_id=user._id) }}" class="d-inline">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                                            <button type="submit" class="dropdown-item text-danger" 
                                                                    onclick="return confirm('PERMANENTLY DELETE user {{ user.email }}? This action cannot be undone!')">
                                                                Permanent Delete
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <h4>No Users Found</h4>
                <p>There are currently no users in the system.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Simple Modal for Add User to Role -->
<div id="addUserModal" class="simple-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h5>Add User to Role</h5>
            <button type="button" onclick="closeModal('addUserModal')">&times;</button>
        </div>
        <form id="addUserForm" onsubmit="submitAddUser(event)">
            <div class="modal-body">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <div class="form-group">
                    <label for="userSelect">Select User</label>
                    <select id="userSelect" name="user_id" required>
                        <option value="">Choose a user...</option>
                        {% for user in users %}
                        <option value="{{ user._id }}" data-roles="{{ user.roles|join(',') }}">{{ user.full_name }} ({{ user.email }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" id="roleSelectGroup">
                    <label for="roleSelect">Select Role</label>
                    <select id="roleSelect" name="role_name" required>
                        <option value="">Choose a role...</option>
                        {% for role in roles %}
                        <option value="{{ role.name }}">{{ role.name|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="roleInfo" style="display: none;">
                    <strong>Adding users to role: <span id="selectedRole"></span></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('addUserModal')">Cancel</button>
                <button type="submit">Add Role</button>
            </div>
        </form>
    </div>
</div>

<!-- Simple Confirmation Modal -->
<div id="confirmModal" class="simple-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h5>Confirm Action</h5>
            <button type="button" onclick="closeModal('confirmModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage"></p>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="closeModal('confirmModal')">Cancel</button>
            <button type="button" id="confirmBtn" onclick="executeAction()">Confirm</button>
        </div>
    </div>
</div>

<style>
/* Simple Modal Styles */
.simple-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #ddd;
}

.modal-header h5 {
    margin: 0;
}

.modal-header button {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}

.modal-body {
    padding: 1rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid #ddd;
}

.modal-footer button {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
}

.modal-footer button[type="submit"],
.modal-footer button:last-child {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.form-group select,
.form-group input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

/* Existing styles */
.table-responsive {
    border-radius: 0.375rem;
}

.btn-group {
    white-space: nowrap;
}

.dropdown-menu {
    min-width: 150px;
}

.badge {
    font-size: 0.75em;
}

.table-secondary {
    opacity: 0.7;
}

.table-secondary td {
    font-style: italic;
}

.nav-pills .nav-link.active {
    background-color: var(--bs-primary);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.user-row.hidden {
    display: none;
}
</style>

<script>
// Simple Modal System
let currentFilterRole = 'all';
let pendingAction = null;

// Simple modal functions
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto';
    if (modalId === 'addUserModal') {
        resetAddUserForm();
    }
}

// Close modal when clicking overlay
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        const modal = e.target.closest('.simple-modal');
        if (modal) {
            closeModal(modal.id);
        }
    }
});

// ESC key to close modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openModal = document.querySelector('.simple-modal[style*="display: block"]');
        if (openModal) {
            closeModal(openModal.id);
        }
    }
});

// Add User Modal Functions
function openAddUserModal() {
    const roleSelect = document.getElementById('roleSelect');
    const roleSelectGroup = document.getElementById('roleSelectGroup');
    const roleInfo = document.getElementById('roleInfo');
    const selectedRole = document.getElementById('selectedRole');
    
    if (currentFilterRole !== 'all') {
        // Pre-select role and hide dropdown
        roleSelectGroup.style.display = 'none';
        roleInfo.style.display = 'block';
        selectedRole.textContent = currentFilterRole.charAt(0).toUpperCase() + currentFilterRole.slice(1);
        
        // Filter users who don't have this role
        filterUsersForRole(currentFilterRole);
    } else {
        // Show role dropdown
        roleSelectGroup.style.display = 'block';
        roleInfo.style.display = 'none';
        showAllUsers();
    }
    
    openModal('addUserModal');
}

function resetAddUserForm() {
    document.getElementById('addUserForm').reset();
    document.getElementById('roleSelectGroup').style.display = 'block';
    document.getElementById('roleInfo').style.display = 'none';
    showAllUsers();
}

function submitAddUser(event) {
    event.preventDefault();
    
    const form = event.target;
    const userId = document.getElementById('userSelect').value;
    const roleSelect = document.getElementById('roleSelect');
    
    let roleName;
    if (currentFilterRole !== 'all') {
        roleName = currentFilterRole;
    } else {
        roleName = roleSelect.value;
    }
    
    if (!userId || !roleName) {
        alert('Please select both a user and a role.');
        return;
    }
    
    // Submit form
    const formData = new FormData();
    formData.append('csrf_token', '{{ csrf_token }}');
    formData.append('user_id', userId);
    formData.append('role_name', roleName);
    
    fetch('/superuser/add-user-to-role', {
        method: 'POST',
        body: formData
    })
    .then(() => {
        closeModal('addUserModal');
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding role to user.');
    });
}

// Confirmation Modal Functions
function confirmAction(message, url, data = {}) {
    document.getElementById('confirmMessage').textContent = message;
    pendingAction = { url, data };
    openModal('confirmModal');
}

function executeAction() {
    if (!pendingAction) return;
    
    const formData = new FormData();
    formData.append('csrf_token', '{{ csrf_token }}');
    
    for (const [key, value] of Object.entries(pendingAction.data)) {
        formData.append(key, value);
    }
    
    fetch(pendingAction.url, {
        method: 'POST',
        body: formData
    })
    .then(() => {
        closeModal('confirmModal');
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing request.');
    });
    
    pendingAction = null;
}

// User filtering functions
function filterUsersForRole(roleName) {
    const userSelect = document.getElementById('userSelect');
    const options = userSelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (!option.value) return;
        
        const userRoles = option.dataset.roles ? option.dataset.roles.split(',') : [];
        option.style.display = userRoles.includes(roleName) ? 'none' : 'block';
    });
}

function showAllUsers() {
    const userSelect = document.getElementById('userSelect');
    const options = userSelect.querySelectorAll('option');
    
    options.forEach(option => {
        option.style.display = 'block';
    });
}

// Role filtering functionality
function filterByRole(selectedRole) {
    const rows = document.querySelectorAll('.user-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const userRoles = row.getAttribute('data-user-roles').split(',');
        
        if (selectedRole === 'all' || userRoles.includes(selectedRole)) {
            row.classList.remove('hidden');
            visibleCount++;
        } else {
            row.classList.add('hidden');
        }
    });
    
    document.querySelector('.badge.bg-info').textContent = `Visible Users: ${visibleCount}`;
}

function updateAddButtonText(selectedRole) {
    const addButtonText = document.getElementById('addButtonText');
    if (selectedRole === 'all') {
        addButtonText.textContent = 'Add User to Role';
    } else {
        addButtonText.textContent = `Add User to ${selectedRole.charAt(0).toUpperCase() + selectedRole.slice(1)}`;
    }
}

// Tab management
document.addEventListener('tabChanged', function(event) {
    if (event.detail.containerId === 'user-management') {
        currentFilterRole = event.detail.tabId;
        filterByRole(currentFilterRole);
        updateAddButtonText(currentFilterRole);
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.user-row');
    const roleCounts = { 'all': rows.length };
    
    // Count users for each role
    rows.forEach(row => {
        const userRoles = row.getAttribute('data-user-roles').split(',');
        userRoles.forEach(role => {
            if (role.trim()) {
                roleCounts[role] = (roleCounts[role] || 0) + 1;
            }
        });
    });
    
    // Update badge counts
    Object.keys(roleCounts).forEach(role => {
        const countElement = document.getElementById(`${role}-count`);
        if (countElement) {
            countElement.textContent = roleCounts[role];
        }
    });
    
    // Initialize with active tab
    if (window.tabManager) {
        const activeTab = window.tabManager.getActiveTab('user-management');
        if (activeTab) {
            currentFilterRole = activeTab;
            filterByRole(currentFilterRole);
            updateAddButtonText(currentFilterRole);
        }
    }
});

// Handle role selection in add user form
document.getElementById('roleSelect').addEventListener('change', function() {
    if (this.value) {
        filterUsersForRole(this.value);
    } else {
        showAllUsers();
    }
});
</script>
{% endblock %}