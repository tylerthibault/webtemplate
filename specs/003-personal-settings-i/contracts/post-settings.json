{
  "contract_name": "Update User Profile Settings",
  "endpoint": "/settings",
  "method": "POST",
  "authentication": {
    "required": true,
    "type": "session + CSRF",
    "description": "User must be logged in with valid session and provide CSRF token"
  },
  "request": {
    "headers": {
      "Cookie": "session=<session_token> (required)",
      "Content-Type": "application/json",
      "X-CSRF-Token": "<csrf_token> (required)"
    },
    "body": {
      "schema": {
        "type": "object",
        "required": ["full_name", "email", "updated_at"],
        "properties": {
          "full_name": {
            "type": "string",
            "minLength": 2,
            "maxLength": 100,
            "description": "User's full name",
            "example": "Jane Doe"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "User's email address (unique)",
            "example": "jane@example.com"
          },
          "bio": {
            "type": ["string", "null"],
            "maxLength": 500,
            "description": "User biography (optional)",
            "example": "Full-stack developer and open source contributor"
          },
          "current_password": {
            "type": ["string", "null"],
            "description": "Required when changing email or password",
            "example": "OldPassword123"
          },
          "new_password": {
            "type": ["string", "null"],
            "minLength": 8,
            "pattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).+$",
            "description": "New password (optional, requires current_password)",
            "example": "NewPassword456"
          },
          "profile_picture_data": {
            "type": ["string", "null"],
            "description": "Base64-encoded image data (optional)",
            "example": "/9j/4AAQSkZJRgABAQAA..."
          },
          "profile_picture_mime_type": {
            "type": ["string", "null"],
            "enum": ["image/jpeg", "image/png", "image/gif", null],
            "description": "MIME type of uploaded image",
            "example": "image/jpeg"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp from GET response (for concurrent edit detection)",
            "example": "2025-10-06T15:45:30Z"
          }
        }
      },
      "example": {
        "full_name": "Jane Doe",
        "email": "jane@example.com",
        "bio": "Full-stack developer and open source contributor",
        "current_password": null,
        "new_password": null,
        "profile_picture_data": null,
        "profile_picture_mime_type": null,
        "updated_at": "2025-10-06T15:45:30Z"
      }
    }
  },
  "response": {
    "success": {
      "status_code": 200,
      "content_type": "application/json",
      "schema": {
        "type": "object",
        "required": ["success", "message", "user"],
        "properties": {
          "success": {
            "type": "boolean",
            "const": true
          },
          "message": {
            "type": "string",
            "example": "Profile updated successfully"
          },
          "user": {
            "type": "object",
            "description": "Updated user profile",
            "properties": {
              "id": {"type": "integer"},
              "full_name": {"type": "string"},
              "email": {"type": "string"},
              "bio": {"type": ["string", "null"]},
              "profile_picture_mime_type": {"type": ["string", "null"]},
              "updated_at": {"type": "string", "format": "date-time"}
            }
          }
        }
      },
      "example": {
        "success": true,
        "message": "Profile updated successfully",
        "user": {
          "id": 42,
          "full_name": "Jane Doe",
          "email": "jane@example.com",
          "bio": "Full-stack developer and open source contributor",
          "profile_picture_mime_type": null,
          "updated_at": "2025-10-06T16:00:00Z"
        }
      }
    },
    "errors": [
      {
        "status_code": 400,
        "description": "Validation error - invalid input data",
        "schema": {
          "type": "object",
          "properties": {
            "error": {"type": "string"},
            "errors": {
              "type": "object",
              "description": "Field-specific error messages",
              "example": {
                "full_name": "Full name must be at least 2 characters",
                "email": "Invalid email format",
                "bio": "Bio exceeds 500 character limit",
                "new_password": "Password must contain uppercase, lowercase, and number"
              }
            }
          }
        }
      },
      {
        "status_code": 401,
        "description": "Not authenticated - no valid session",
        "schema": {
          "type": "object",
          "properties": {
            "error": {"type": "string", "example": "Authentication required"}
          }
        }
      },
      {
        "status_code": 403,
        "description": "CSRF token invalid or missing",
        "schema": {
          "type": "object",
          "properties": {
            "error": {"type": "string", "example": "CSRF validation failed"}
          }
        }
      },
      {
        "status_code": 409,
        "description": "Concurrent modification detected - data changed since form loaded",
        "schema": {
          "type": "object",
          "properties": {
            "error": {"type": "string", "example": "Profile was modified by another session"},
            "current_data": {
              "type": "object",
              "description": "Current user profile data for conflict resolution"
            },
            "conflicting_fields": {
              "type": "array",
              "items": {"type": "string"},
              "example": ["full_name", "email"]
            }
          }
        }
      },
      {
        "status_code": 422,
        "description": "Current password incorrect (when changing email/password)",
        "schema": {
          "type": "object",
          "properties": {
            "error": {"type": "string", "example": "Current password is incorrect"},
            "field": {"type": "string", "const": "current_password"}
          }
        }
      }
    ]
  },
  "test_scenarios": [
    {
      "name": "Update full name successfully",
      "preconditions": ["User logged in", "Valid CSRF token"],
      "request_body": {
        "full_name": "New Name",
        "email": "user@example.com",
        "bio": null,
        "updated_at": "2025-10-06T15:45:30Z"
      },
      "expected_status": 200,
      "expected_response_contains": ["success: true", "full_name: New Name"]
    },
    {
      "name": "Email validation error",
      "preconditions": ["User logged in"],
      "request_body": {
        "full_name": "User",
        "email": "invalid-email",
        "updated_at": "2025-10-06T15:45:30Z"
      },
      "expected_status": 400,
      "expected_response_contains": ["errors", "email"]
    },
    {
      "name": "Concurrent edit conflict",
      "preconditions": ["User logged in", "Data modified by another session"],
      "request_body": {
        "full_name": "User",
        "email": "user@example.com",
        "updated_at": "2025-10-06T15:00:00Z"
      },
      "expected_status": 409,
      "expected_response_contains": ["current_data", "conflicting_fields"]
    },
    {
      "name": "Password change requires current password",
      "preconditions": ["User logged in"],
      "request_body": {
        "full_name": "User",
        "email": "user@example.com",
        "new_password": "NewPass123",
        "current_password": null,
        "updated_at": "2025-10-06T15:45:30Z"
      },
      "expected_status": 400,
      "expected_response_contains": ["current_password required"]
    },
    {
      "name": "Email change sends notifications",
      "preconditions": ["User logged in", "Current password provided"],
      "request_body": {
        "full_name": "User",
        "email": "newemail@example.com",
        "current_password": "CurrentPass123",
        "updated_at": "2025-10-06T15:45:30Z"
      },
      "expected_status": 200,
      "expected_side_effect": "Two emails sent (old address, new address)"
    }
  ],
  "notes": [
    "current_password required when changing email or password (security)",
    "updated_at must match current database value (concurrent edit detection)",
    "Profile picture data not returned in response (too large), only MIME type",
    "Email change triggers async notification emails",
    "Password change uses bcrypt with cost factor 12",
    "Bio sanitized to prevent XSS before storage"
  ]
}
